#!/usr/bin/env bash

# Disable Xdebug.
phpenv config-rm xdebug.ini

# Install the PECL YAML parser for strict YAML parsing.
yes | pecl install yaml

# Install Composer optimizations for faster builds.
composer global require hirak/prestissimo
composer global require zaporylie/composer-drupal-optimizations

# Make Composer Patches throw an error when it can't apply a patch.
export COMPOSER_EXIT_ON_PATCH_FAILURE=1

# Install ORCA.
ORCA_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
composer --no-dev -d${ORCA_ROOT} install

# Handle a branch name argument.
if [[ ! -z "$1" && $(git -C ${TRAVIS_BUILD_DIR} rev-parse --abbrev-ref HEAD) != "$1" ]]; then
  git -C ${TRAVIS_BUILD_DIR} branch -f "$1"
  git -C ${TRAVIS_BUILD_DIR} checkout "$1"
fi
