#!/usr/bin/env bash

# NAME
#     install - Install Travis CI dependencies
#
# SYNOPSIS
#     install
#
# DESCRIPTION
#     Configures the Travis CI environment and installs ORCA.

set -e

# Prevent script from being run locally, which can lead to a broken environment.
if [[ -z "$TRAVIS" ]]; then
  echo "Error: This script is meant to run on Travis CI only."
  exit 1
fi

# Executes a Git command in the Travis CI build directory
function gitc {
  git -C ${TRAVIS_BUILD_DIR} $@
}

# Disable Xdebug.
phpenv config-rm xdebug.ini

# Install the PECL YAML parser for strict YAML parsing.
yes | pecl install yaml

# Install Composer optimizations for faster builds.
composer global require hirak/prestissimo
composer global require zaporylie/composer-drupal-optimizations

# Make Composer Patches throw an error when it can't apply a patch.
export COMPOSER_EXIT_ON_PATCH_FAILURE=1

# Install ORCA.
ORCA_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
composer --no-dev -d${ORCA_ROOT} install
