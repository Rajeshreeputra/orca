#!/usr/bin/env bash

# NAME
#     script - Run ORCA tests
#
# SYNOPSIS
#     script <sut>
#
# DESCRIPTION
#     Creates test fixtures and runs static code analysis and automated tests.
#
# OPTIONS
#     <sut>
#         The package name of the system under test (SUT), e.g., drupal/example
#         or acquia/example.

set -e

# Require the SUT argument.
if [[ -z "$1" ]]; then
  echo "Missing required SUT argument, e.g.:"
  echo "$0 drupal/example"
  exit 127
fi

# Executes an ORCA command
function orca {
  COMMAND="${ORCA_ROOT}/bin/orca $@"
  echo "> $COMMAND"
  eval ${COMMAND}
}

ORCA_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
ORCA_JOB=${ORCA_JOB:=ALL}

[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "STATIC_CODE_ANALYSIS" ]] && STATIC_CODE_ANALYSIS=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "DEPRECATED_CODE_SCAN_SUT" ]] && DEPRECATED_CODE_SCAN_SUT=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "DEPRECATED_CODE_SCAN_CONTRIB" ]] && DEPRECATED_CODE_SCAN_CONTRIB=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "ISOLATED_RECOMMENDED" ]] && ISOLATED_RECOMMENDED=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "INTEGRATED_RECOMMENDED" ]] && INTEGRATED_RECOMMENDED=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "ISOLATED_DEV" ]] && ISOLATED_DEV=true
[[ ${ORCA_JOB} == "ALL" || ${ORCA_JOB} = "INTEGRATED_DEV" ]] && INTEGRATED_DEV=true

# Static code analysis.
# ------------------------------------------------------------------------------
[[ "$STATIC_CODE_ANALYSIS" ]] && orca static-analysis:run ./

# Deprecated code scan w/ SUT.
# ------------------------------------------------------------------------------
if [[ "$DEPRECATED_CODE_SCAN_SUT" ]]; then
  orca fixture:init -f --sut=$1 --sut-only
  orca fixture:status
  orca deprecated-code-scan:run --sut=$1
fi

# Deprecated code scan w/ dependencies.
# ------------------------------------------------------------------------------
if [[ "$DEPRECATED_CODE_SCAN_CONTRIB" ]]; then
  orca fixture:init -f --sut=$1 --sut-only
  orca fixture:status
  orca deprecated-code-scan:run --contrib
fi

# Isolated test w/ recommended package versions.
# ------------------------------------------------------------------------------
if [[ "$ISOLATED_RECOMMENDED" ]]; then
  orca fixture:init -f --sut=$1 --sut-only
  orca fixture:status
  orca tests:run --sut=$1 --sut-only
fi

# Integrated test w/ recommended package versions.
# ------------------------------------------------------------------------------
if [[ "$INTEGRATED_RECOMMENDED" ]]; then
  orca fixture:init -f --sut=$1
  orca fixture:status
  orca tests:run --sut=$1
fi

# Isolated test w/ dev package versions.
# ------------------------------------------------------------------------------
if [[ "$ISOLATED_DEV" ]]; then
  orca fixture:init -f --sut=$1 --sut-only --dev
  orca fixture:status
  orca tests:run --sut=$1 --sut-only
fi

# Integrated test w/ dev package versions.
# ------------------------------------------------------------------------------
if [[ "$INTEGRATED_DEV" ]]; then
  orca fixture:init -f --sut=$1 --dev
  orca fixture:status
  orca tests:run --sut=$1
fi
